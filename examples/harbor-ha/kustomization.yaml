# Copyright (c) 2020 SIGHUP s.r.l All rights reserved.  Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: harbor

resources:
  - ns.yml

bases:
  - ../../katalog/harbor/distributions/harbor-without-dbs
  - haproxy

configMapGenerator:
  # ChartMuseum overwritable configuration
  - name: chartmuseum
    behavior: merge
    literals:
      - CACHE=redis
      - CACHE_REDIS_ADDR=haproxy-redis:6379
      - CACHE_REDIS_DB=3
      - BASIC_AUTH_USER=chart_controller
      - DEBUG=false
    # Clair overwritable configuration
  - name: clair
    behavior: merge
    literals:
      - HTTP_PROXY=
      - HTTPS_PROXY=
      - SCANNER_LOG_LEVEL=info
    # Core overwritable configuration
  - name: core
    behavior: merge
    files:
      - app.conf=config/core/app.conf
    literals:
      - POSTGRESQL_HOST=example-cluster-postgres.postgres-cluster-1.svc.cluster.local
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_USERNAME=postgres
      - POSTGRESQL_DATABASE=registry
      - POSTGRESQL_SSLMODE=require
      - EXT_ENDPOINT=http://harbor.sighup-example.com
      - CLAIR_DB_HOST=example-cluster-postgres.postgres-cluster-1.svc.cluster.local
      - CLAIR_DB_PORT=5432
      - CLAIR_DB_USERNAME=postgres
      - CLAIR_DB=postgres
      - CLAIR_DB_SSLMODE=require
      - LOG_LEVEL=debug
      - CHART_CACHE_DRIVER=redis
      - _REDIS_URL_REG=redis://haproxy-redis:6379/1?idle_timeout_seconds=30
      - _REDIS_URL_CORE=redis://haproxy-redis:6379/0?idle_timeout_seconds=30
      - PORTAL_URL=http://portal
      - HTTP_PROXY=
      - HTTPS_PROXY=
    # JobService overwritable configuration
  - name: jobservice
    behavior: merge
    files:
      - config.yml=config/jobservice/config.yml
    literals:
      - LOG_LEVEL=debug
      - HTTP_PROXY=
      - HTTPS_PROXY=
    # Registry overwritable configuration
  - name: registry
    behavior: replace
    files:
      - config.yml=config/registry/config.yml
      - ctl-config.yml=config/registry/ctl-config.yml

secretGenerator:
  # ChartMuseum overwritable configuration
  - name: chartmuseum
    behavior: merge
    literals:
      - CACHE_REDIS_MASTERNAME=mymaster
      - CACHE_REDIS_PASSWORD=""
    # Clair overwritable configuration
  - name: clair
    behavior: merge
    files:
      - config.yaml=secrets/clair/config.yaml
    literals:
      - SCANNER_STORE_REDIS_URL=haproxy-redis:6379
      #get the password of the user from the secret of the postgresql cluster namespace and change here accordingly instead of `changeit`
      - SCANNER_CLAIR_DATABASE_URL=postgres://postgres:RhtBttYV22D3DWVgXIg1WGewDCrx19vlvfnxciWBAhxSrHgvvv6I6cxPecEaHX4y@example-cluster-postgres.postgres-cluster-1.svc:5432/postgres?sslmode=disable
    # Core overwritable configuration
  - name: core
    behavior: merge
    literals:
      - secretKey=not-a-secure-key
      - secret=P447FhxLeLwjDMYU
      - HARBOR_ADMIN_PASSWORD=Harbor12345
      #get the password of the user from the secret of the postgresql cluster namespace and change here accordingly instead of `changeit`
      - POSTGRESQL_PASSWORD=RhtBttYV22D3DWVgXIg1WGewDCrx19vlvfnxciWBAhxSrHgvvv6I6cxPecEaHX4y
      - CLAIR_DB_PASSWORD=RhtBttYV22D3DWVgXIg1WGewDCrx19vlvfnxciWBAhxSrHgvvv6I6cxPecEaHX4y
    # Database overwritable configuration
    # JobService overwritable configuration
  - name: jobservice
    behavior: merge
    literals:
      - secret=Gx6IsNtY4NdWoK0u
    # Notary overwritable configuration
  - name: notary-server
    behavior: merge
    files:
      - server.json=secrets/notary/server.json
    literals:
      #get the password of the user from the secret of the postgresql cluster namespace and change here accordingly instead of `changeit`
      - DB_URL=postgres://postgres:RhtBttYV22D3DWVgXIg1WGewDCrx19vlvfnxciWBAhxSrHgvvv6I6cxPecEaHX4y@example-cluster-postgres.postgres-cluster-1.svc:5432/notaryserver?sslmode=disable
  - name: notary-signer
    behavior: merge
    files:
      - signer.json=secrets/notary/signer.json
    literals:
      #get the password of the user from the secret of the postgresql cluster namespace and change here accordingly instead of `changeit`
      - DB_URL=postgres://postgres:RhtBttYV22D3DWVgXIg1WGewDCrx19vlvfnxciWBAhxSrHgvvv6I6cxPecEaHX4y@example-cluster-postgres.postgres-cluster-1.svc:5432/notarysigner?sslmode=disable
    # Registry overwritable configuration
  - name: registry
    behavior: merge
    literals:
      - REGISTRY_HTTP_SECRET=Z6HTqCsLzHMmgr9W
      - REGISTRY_REDIS_PASSWORD=""

patches:
  - target:
      kind: Deployment
      name: chartmuseum
    patch: |-
      - op: remove
        path: /spec/template/spec/volumes/0
      - op: remove
      # removing volumeMounts related to pvc volume
        path: /spec/template/spec/containers/0/volumeMounts/0
      - op: replace
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/affinity
        value:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: component
                      operator: In
                      values:
                        - chartmuseum
                topologyKey: kubernetes.io/hostname
  - target:
      kind: Deployment
      name: clair
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/affinity
        value:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: component
                      operator: In
                      values:
                        - clair
                topologyKey: kubernetes.io/hostname
  - target:
      kind: Deployment
      name: core
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/affinity
        value:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: component
                      operator: In
                      values:
                        - core
                topologyKey: kubernetes.io/hostname
  - target:
      kind: Deployment
      name: jobservice
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/affinity
        value:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: component
                      operator: In
                      values:
                        - jobservice
                topologyKey: kubernetes.io/hostname
  - target:
      kind: Deployment
      name: notary-server
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/affinity
        value:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: component
                      operator: In
                      values:
                        - notary-server
                topologyKey: kubernetes.io/hostname
  - target:
      kind: Deployment
      name: portal
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/affinity
        value:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: component
                      operator: In
                      values:
                        - portal
                topologyKey: kubernetes.io/hostname
  - target:
      kind: Deployment
      name: registry
    patch: |-
      # removing persistentVolumeClaim volume
      - op: remove
        path: /spec/template/spec/volumes/3
      - op: remove
      # removing volumeMounts related to pvc volume
        path: /spec/template/spec/containers/0/volumeMounts/0
      - op: remove
      # removing volumeMounts related to pvc volume
        path: /spec/template/spec/containers/1/volumeMounts/0
      - op: replace
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/affinity
        value:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: component
                      operator: In
                      values:
                        - registry
                topologyKey: kubernetes.io/hostname

patchesJson6902:
  - target:
      group: ""
      version: v1
      kind: PersistentVolumeClaim
      name: pvc-chartmuseum
    path: patch/chartmuseum.yml
  - target:
      group: ""
      version: v1
      kind: PersistentVolumeClaim
      name: registry
    path: patch/registry.yml
  - target:
      group: networking.k8s.io
      version: v1beta1
      kind: Ingress
      name: harbor-ingress
    path: patch/ingress.yml

images:
  - name: goharbor/chartmuseum-photon
    newName: reg.sighup.io/sighupio/fury/goharbor/chartmuseum-photon
    newTag: v2.1.3
  - name: goharbor/clair-photon
    newName: reg.sighup.io/sighupio/fury/goharbor/clair-photon
    newTag: v2.1.3
  - name: goharbor/clair-adapter-photon
    newName: reg.sighup.io/sighupio/fury/goharbor/clair-adapter-photon
    newTag: v2.1.3
  - name: goharbor/harbor-core
    newName: docker.io/goharbor/harbor-core
    newTag: v2.2.0-dev
  - name: goharbor/harbor-jobservice
    newName: reg.sighup.io/sighupio/fury/goharbor/harbor-jobservice
    newTag: v2.1.3
  - name: goharbor/notary-server-photon
    newName: reg.sighup.io/sighupio/fury/goharbor/notary-server-photon
    newTag: v2.1.3
  - name: goharbor/notary-signer-photon
    newName: reg.sighup.io/sighupio/fury/goharbor/notary-signer-photon
    newTag: v2.1.3
  - name: goharbor/harbor-portal
    newName: reg.sighup.io/sighupio/fury/goharbor/harbor-portal
    newTag: v2.1.3
  - name: goharbor/registry-photon
    newName: reg.sighup.io/sighupio/fury/goharbor/registry-photon
    newTag: v2.1.3
  - name: goharbor/harbor-registryctl
    newName: reg.sighup.io/sighupio/fury/goharbor/harbor-registryctl
    newTag: v2.1.3
